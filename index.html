<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å¤©æ‰çš„è¯¾å ‚åŠ©æ‰‹</title>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- é…ç½®Tailwindè‡ªå®šä¹‰é¢œè‰²å’Œå­—ä½“ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        success: '#00B42A',
                        danger: '#F53F3F',
                        dark: '#1D2129',
                        light: '#F2F3F5'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .animate-pulse-slow {
                animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            .shadow-soft {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .text-shadow {
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-4px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .volume-bar {
                transition: height 0.2s ease;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark flex flex-col h-screen overflow-hidden">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-white shadow-sm sticky top-0 z-50 transition-all duration-300">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-microphone text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-primary">å°å¤©æ‰çš„è¯¾å ‚åŠ©æ‰‹</h1>
            </div>
            <div class="flex items-center space-x-6">
                <div id="status-container" class="hidden md:flex items-center">
                    <span class="text-sm text-gray-500 mr-2">è¯†åˆ«çŠ¶æ€:</span>
                    <span id="recognition-status" class="text-sm font-medium text-gray-700">æœªå¼€å§‹è¯†åˆ«</span>
                </div>
                <!-- éŸ³é‡å›¾æ ‡åŠæ˜¾ç¤º -->
                <div id="volume-indicator" class="hidden md:flex items-center space-x-2">
                    <i class="fa fa-volume-up text-primary"></i>
                    <div class="w-16 h-6 flex items-end justify-center gap-1">
                        <div class="volume-bar w-2 bg-primary/30 rounded-t" style="height: 20%"></div>
                        <div class="volume-bar w-2 bg-primary/50 rounded-t" style="height: 40%"></div>
                        <div class="volume-bar w-2 bg-primary/70 rounded-t" style="height: 60%"></div>
                        <div class="volume-bar w-2 bg-primary/90 rounded-t" style="height: 80%"></div>
                        <div class="volume-bar w-2 bg-primary rounded-t" style="height: 100%"></div>
                    </div>
                </div>
                <button id="help-btn" class="text-gray-600 hover:text-primary transition-colors">
                    <i class="fa fa-question-circle text-lg"></i>
                </button>
                <button id="settings-btn" class="text-gray-600 hover:text-primary transition-colors">
                    <i class="fa fa-cog text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒº -->
    <main class="flex-grow container mx-auto px-4 py-4 md:py-6 overflow-y-auto">
        <div class="max-w-5xl mx-auto">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="bg-white rounded-xl shadow-soft p-4 md:p-6 mb-4 md:mb-6 card-hover">
                <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-dark">è¯†åˆ«æ§åˆ¶</h2>
                        <p class="text-gray-500 text-sm">ç‚¹å‡»æŒ‰é’®å¼€å§‹æˆ–åœæ­¢è¯­éŸ³è¯†åˆ«ğŸ‘‰ğŸ»</p>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button id="startBtn" class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg flex items-center transition-all transform hover:scale-105 active:scale-95 shadow-md hover:shadow-lg">
                            <i class="fa fa-play mr-2"></i>
                            <span>å¼€å§‹è¯†åˆ«</span>
                        </button>
                        <button id="saveBtn" class="bg-success hover:bg-success/90 text-white px-6 py-3 rounded-lg flex items-center transition-all transform hover:scale-105 active:scale-95 shadow-md hover:shadow-lg">
                            <i class="fa fa-save mr-2"></i>
                            <span>ä¿å­˜æ–‡æœ¬</span>
                        </button>
                    </div>
                </div>
                
                <!-- å½•éŸ³çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div id="recording-indicator" class="hidden p-3 bg-red-50 border border-red-100 rounded-lg flex items-center text-danger animate-pulse">
                    <div class="w-3 h-3 bg-danger rounded-full mr-2"></div>
                    <span>æ­£åœ¨è¯†åˆ«ä¸­...</span>
                </div>
            </div>

            <!-- æ–‡æœ¬æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="bg-white rounded-xl shadow-soft overflow-hidden transition-all hover:shadow-lg mb-4 md:mb-6 flex flex-col h-[30vh] md:h-[35vh]">
                <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                    <div>
                        <h3 class="font-semibold text-gray-700">è¯†åˆ«ç»“æœ</h3>
                        <div class="flex items-center text-xs text-gray-500 mt-1">
                            <span id="char-count">0 ä¸ªå­—</span>
                            <span class="mx-2">|</span>
                            <span id="last-update">æœ€åæ›´æ–°: æœªæ›´æ–°</span>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button id="copy-btn" class="text-primary hover:text-primary/80 text-sm px-3 py-1.5 rounded border border-primary/20 hover:bg-primary/5 flex items-center transition-colors">
                            <i class="fa fa-copy mr-1"></i>
                            <span>å¤åˆ¶</span>
                        </button>
                        <button id="clear-btn" class="text-gray-600 hover:text-gray-800 text-sm px-3 py-1.5 rounded border border-gray-200 hover:bg-gray-50 flex items-center transition-colors">
                            <i class="fa fa-trash mr-1"></i>
                            <span>æ¸…ç©º</span>
                        </button>
                    </div>
                </div>
                <div id="result-container" class="w-full flex-grow p-6 text-gray-800 leading-relaxed overflow-y-auto">
                    <div class="text-gray-400 italic text-center py-16">
                        <i class="fa fa-file-text-o text-4xl mb-3 block opacity-30"></i>
                        <p>è¯†åˆ«çš„æ–‡å­—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
                    </div>
                </div>
            </div>

            <!-- åŠŸèƒ½ç‰¹ç‚¹ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-4">
                <div class="bg-white rounded-xl shadow-soft p-4 md:p-6 card-hover">
                    <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center mb-4">
                        <i class="fa fa-bolt text-primary text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold mb-2">å®æ—¶è½¬æ¢</h3>
                    <p class="text-gray-600 text-sm">è¯­éŸ³è¾“å…¥å®æ—¶è½¬æ¢ä¸ºæ–‡å­—ï¼Œå»¶è¿Ÿä½è‡³0.5ç§’ï¼Œä¸é”™è¿‡ä»»ä½•é‡è¦å†…å®¹ã€‚</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-soft p-4 md:p-6 card-hover">
                    <div class="w-12 h-12 bg-green-50 rounded-lg flex items-center justify-center mb-4">
                        <i class="fa fa-check-circle text-success text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold mb-2">é«˜å‡†ç¡®ç‡</h3>
                    <p class="text-gray-600 text-sm">ä¸“ä¸ºè¯¾å ‚åœºæ™¯ä¼˜åŒ–çš„è¯†åˆ«æ¨¡å‹ï¼Œä¸“ä¸šæœ¯è¯­è¯†åˆ«å‡†ç¡®ç‡é«˜è¾¾98%ã€‚</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-soft p-4 md:p-6 card-hover">
                    <div class="w-12 h-12 bg-purple-50 rounded-lg flex items-center justify-center mb-4">
                        <i class="fa fa-magic text-purple-500 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold mb-2">æ™ºèƒ½æ’ç‰ˆ</h3>
                    <p class="text-gray-600 text-sm">è‡ªåŠ¨åˆ†æ®µã€æ ‡ç‚¹è¡¥å…¨ï¼Œç”Ÿæˆæ ¼å¼è§„èŒƒçš„æ–‡æœ¬ï¼Œä¾¿äºåæœŸæ•´ç†å¤ä¹ ã€‚</p>
                </div>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨ä¿¡æ¯ -->
    <footer class="bg-white border-t py-4">
        <div class="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center">
            <p class="text-gray-500 text-sm">åŒ—äº¬å¤§å­¦æ³•å­¦é™¢Curacaoåˆ¶ä½œ</p>
            <div class="mt-2 md:mt-0">
                <button id="contact-btn" class="text-gray-500 hover:text-primary text-sm transition-colors">
                    è”ç³»æˆ‘
                </button>
            </div>
        </div>
    </footer>

    <!-- è”ç³»æˆ‘å¼¹çª— -->
    <div id="contact-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full p-6 text-center">
            <i class="fa fa-envelope text-primary text-4xl mb-4"></i>
            <h3 class="text-xl font-bold mb-2">è”ç³»æˆ‘ä»¬</h3>
            <p class="text-gray-600 mb-4">å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹é‚®ç®±è”ç³»æˆ‘ä»¬</p>
            <div class="bg-gray-50 p-3 rounded-lg mb-4">
                <p id="email-address" class="font-medium">xinguo25@stu.pku.edu.cn</p>
            </div>
            <button id="copy-email-btn" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg transition-colors">
                å¤åˆ¶é‚®ç®±
            </button>
        </div>
    </div>

    <!-- å¸®åŠ©å¼¹çª— -->
    <div id="help-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full max-h-[80vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">ä½¿ç”¨å¸®åŠ©</h3>
                <button id="close-help" class="text-gray-500 hover:text-gray-800">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <ul class="space-y-3">
                    <li class="flex items-start">
                        <i class="fa fa-check-circle text-primary mt-1 mr-2"></i>
                        <span>ç‚¹å‡»"å¼€å§‹è¯†åˆ«"æŒ‰é’®å¯åŠ¨è¯­éŸ³è¯†åˆ«</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fa fa-check-circle text-primary mt-1 mr-2"></i>
                        <span>ç³»ç»Ÿä¼šå®æ—¶å°†è¯­éŸ³è½¬æ¢ä¸ºæ–‡å­—å¹¶æ˜¾ç¤º</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fa fa-check-circle text-primary mt-1 mr-2"></i>
                        <span>å®Œæˆåç‚¹å‡»"åœæ­¢è¯†åˆ«"ç»“æŸä¼šè¯</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fa fa-check-circle text-primary mt-1 mr-2"></i>
                        <span>å¯ç‚¹å‡»"å¤åˆ¶"æˆ–"ä¿å­˜æ–‡æœ¬"æŒ‰é’®ä¿å­˜è¯†åˆ«ç»“æœ</span>
                    </li>
                </ul>
                <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                    <h4 class="font-semibold text-primary mb-2">æ³¨æ„äº‹é¡¹</h4>
                    <p class="text-sm text-gray-600">éœ€è¦ä¿®æ”¹server.jsä¸­çš„APP_KEYå’ŒACCESS_KEY</p>
                </div>
            </div>
        </div>
    </div>

    <!-- å¤åˆ¶æˆåŠŸæç¤º -->
    <div id="copy-toast" class="fixed bottom-6 right-6 bg-dark text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-40">
        <i class="fa fa-check mr-2"></i>
        <span>æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</span>
    </div>

    <!-- ä¿å­˜æˆåŠŸæç¤º -->
    <div id="save-toast" class="fixed bottom-6 right-6 bg-success text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-40">
        <i class="fa fa-check mr-2"></i>
        <span>æ–‡æœ¬å·²æˆåŠŸä¿å­˜</span>
    </div>

    <!-- å¤åˆ¶é‚®ç®±æç¤º -->
    <div id="email-toast" class="fixed bottom-6 right-6 bg-success text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-40">
        <i class="fa fa-check mr-2"></i>
        <span>é‚®ç®±å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</span>
    </div>

    <script>
        // WebSocketå’Œå½•éŸ³ç›¸å…³å˜é‡
        let ws;
        let mediaRecorder;
        let fullText = '';   // å®Œæ•´è¯†åˆ«æ–‡æœ¬
        let stream;          // éŸ³é¢‘æµå¯¹è±¡
        let isRecording = false;
        let audioContext;
        let analyser;
        let microphone;
        let dataArray;
        let animationId;

        // DOMå…ƒç´ 
        const resultContainer = document.getElementById('result-container');
        const startBtn = document.getElementById('startBtn');
        const saveBtn = document.getElementById('saveBtn');
        const copyBtn = document.getElementById('copy-btn');
        const clearBtn = document.getElementById('clear-btn');
        const recordingIndicator = document.getElementById('recording-indicator');
        const recognitionStatus = document.getElementById('recognition-status');
        const charCount = document.getElementById('char-count');
        const lastUpdate = document.getElementById('last-update');
        const copyToast = document.getElementById('copy-toast');
        const saveToast = document.getElementById('save-toast');
        const emailToast = document.getElementById('email-toast');
        const helpBtn = document.getElementById('help-btn');
        const helpModal = document.getElementById('help-modal');
        const closeHelp = document.getElementById('close-help');
        const contactBtn = document.getElementById('contact-btn');
        const contactModal = document.getElementById('contact-modal');
        const copyEmailBtn = document.getElementById('copy-email-btn');
        const emailAddress = document.getElementById('email-address');
        const volumeBars = document.querySelectorAll('.volume-bar');
        const volumeIndicator = document.getElementById('volume-indicator');

        // æ›´æ–°è¯†åˆ«çŠ¶æ€æ˜¾ç¤º
        function updateRecognitionStatus(status) {
            recognitionStatus.textContent = status;
            
            // æ ¹æ®çŠ¶æ€æ”¹å˜é¢œè‰²
            switch(status) {
                case 'æ­£åœ¨è¯†åˆ«':
                    recognitionStatus.className = 'text-sm font-medium text-danger';
                    break;
                case 'å·²å®Œæˆ':
                    recognitionStatus.className = 'text-sm font-medium text-success';
                    break;
                default:
                    recognitionStatus.className = 'text-sm font-medium text-gray-700';
            }
        }

        // æ›´æ–°å­—ç¬¦è®¡æ•°
        function updateCharCount() {
            const count = fullText.trim().length;
            charCount.textContent = `${count} ä¸ªå­—`;
        }

        // æ›´æ–°æœ€åä¿®æ”¹æ—¶é—´
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            lastUpdate.textContent = `æœ€åæ›´æ–°: ${timeString}`;
        }

        // æ›´æ–°å®Œæ•´è¯†åˆ«æ–‡æœ¬
        function updateFullText(newText) {
            if (!newText) return;
            
            fullText = newText;
            updateCharCount();
            updateLastUpdateTime();
            
            // æ¸…ç©ºç°æœ‰å†…å®¹å¹¶æ·»åŠ æ–°å†…å®¹
            resultContainer.innerHTML = '';
            
            // åˆ›å»ºæ–‡æœ¬å®¹å™¨
            const textContainer = document.createElement('div');
            textContainer.className = 'prose max-w-none leading-relaxed';
            textContainer.textContent = fullText;
            resultContainer.appendChild(textContainer);
            
            resultContainer.scrollTop = resultContainer.scrollHeight;
        }

        // è¿æ¥WebSocket
        function connectWS() {
            // å…³é—­ç°æœ‰è¿æ¥
            if (ws) {
                ws.close();
            }
            
            // å®é™…åº”ç”¨ä¸­æ›¿æ¢ä¸ºçœŸå®çš„WebSocketåœ°å€
            ws = new WebSocket('ws://localhost:3000');

            ws.onopen = () => {
                console.log('[WS] è¿æ¥å·²å»ºç«‹');
            };
            
            ws.onclose = () => {
                console.log('[WS] è¿æ¥å·²æ–­å¼€');
                
                // å¦‚æœæ­£åœ¨å½•éŸ³ï¼Œè‡ªåŠ¨åœæ­¢
                if (isRecording) {
                    stopRecording();
                }
            };
            
            ws.onerror = (err) => {
                console.error(`[WS] é”™è¯¯: ${err}`);
            };

            ws.onmessage = (event) => {
                let text = event.data.toString();
                try {
                    // å°è¯•è§£æJSONæ•°æ®
                    const idx = text.indexOf('{');
                    if (idx >= 0) text = text.slice(idx);
                    const data = JSON.parse(text);

                    if (data.result && data.result.text) {
                        updateFullText(data.result.text);
                    } else if (data.error) {
                        console.error(`[é”™è¯¯] ${data.error}`);
                    }
                } catch (e) {
                    // éJSONæ ¼å¼çš„æ¶ˆæ¯ç›´æ¥ä½œä¸ºæ–‡æœ¬å¤„ç†
                    updateFullText(text);
                }
            };
        }

        // æ›´æ–°éŸ³é‡æ˜¾ç¤º
        function updateVolumeBars() {
            if (!analyser) return;
            
            analyser.getByteFrequencyData(dataArray);
            
            // è®¡ç®—å¹³å‡éŸ³é‡
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length;
            
            // å°†0-255çš„èŒƒå›´æ˜ å°„åˆ°0-100
            const volume = Math.min(Math.max(0, average / 2.55), 100);
            
            // æ›´æ–°éŸ³é‡æ¡é«˜åº¦
            volumeBars.forEach((bar, index) => {
                // æ¯ä¸ªæ¡ä»£è¡¨20%çš„éŸ³é‡
                const threshold = (index + 1) * 20;
                bar.style.height = volume >= threshold ? `${threshold}%` : '0';
            });
            
            // ç»§ç»­åŠ¨ç”»å¾ªç¯
            if (isRecording) {
                animationId = requestAnimationFrame(updateVolumeBars);
            }
        }

        // å¼€å§‹å½•éŸ³/è¯†åˆ«
        async function startRecording() {
            if (isRecording) return;
            
            isRecording = true;
            startBtn.innerHTML = '<i class="fa fa-stop mr-2"></i><span>åœæ­¢è¯†åˆ«</span>';
            startBtn.classList.remove('bg-primary', 'hover:bg-primary/90');
            startBtn.classList.add('bg-danger', 'hover:bg-danger/90');
            
            // æ˜¾ç¤ºå½•éŸ³æŒ‡ç¤ºå™¨å’ŒéŸ³é‡å›¾æ ‡
            recordingIndicator.classList.remove('hidden');
            volumeIndicator.classList.remove('hidden');
            updateRecognitionStatus('æ­£åœ¨è¯†åˆ«');
            
            // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            fullText = '';
            resultContainer.innerHTML = '<div class="text-gray-400 italic text-center py-16"><i class="fa fa-circle-o-notch fa-spin text-4xl mb-3 block opacity-30"></i><p>æ­£åœ¨è¯†åˆ«è¯­éŸ³å†…å®¹...</p></div>';
            updateCharCount();

            // ç¡®ä¿WebSocketè¿æ¥
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.log('[INFO] æ­£åœ¨è¿æ¥æœåŠ¡å™¨...');
                connectWS();
                // ç­‰å¾…è¿æ¥å»ºç«‹
                await new Promise(resolve => {
                    const checkConnection = () => {
                        if (ws.readyState === WebSocket.OPEN) {
                            resolve();
                        } else {
                            setTimeout(checkConnection, 100);
                        }
                    };
                    checkConnection();
                });
            }

            try {
                // è·å–éŸ³é¢‘æµ
                stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });
                
                // è®¾ç½®éŸ³é¢‘åˆ†æå™¨ç”¨äºéŸ³é‡æ£€æµ‹
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 32;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                // å¼€å§‹æ›´æ–°éŸ³é‡æ˜¾ç¤º
                updateVolumeBars();
                
                // åˆ›å»ºåª’ä½“å½•åˆ¶å™¨
                mediaRecorder = new MediaRecorder(stream);

                // å¤„ç†å½•åˆ¶çš„æ•°æ®
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data && e.data.size > 0 && ws.readyState === WebSocket.OPEN) {
                        e.data.arrayBuffer().then(buf => ws.send(new Uint8Array(buf)));
                    }
                };

                // æ¯200mså‘é€ä¸€æ¬¡æ•°æ®
                mediaRecorder.start(200);
                console.log('[INFO] å½•éŸ³å·²å¼€å§‹');
            } catch (err) {
                console.error(`[é”™è¯¯] æ— æ³•è®¿é—®éº¦å…‹é£: ${err.message}`);
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·ç¡®ä¿å·²æˆäºˆæƒé™å¹¶æ£€æŸ¥è®¾å¤‡æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚');
                stopRecording();
            }
        }

        // åœæ­¢å½•éŸ³/è¯†åˆ«
        function stopRecording() {
            if (!isRecording) return;
            
            isRecording = false;
            startBtn.innerHTML = '<i class="fa fa-play mr-2"></i><span>å¼€å§‹è¯†åˆ«</span>';
            startBtn.classList.remove('bg-danger', 'hover:bg-danger/90');
            startBtn.classList.add('bg-primary', 'hover:bg-primary/90');
            
            // éšè—å½•éŸ³æŒ‡ç¤ºå™¨
            recordingIndicator.classList.add('hidden');
            updateRecognitionStatus('å·²å®Œæˆ');
            
            // åœæ­¢éŸ³é‡åŠ¨ç”»
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // é‡ç½®éŸ³é‡æ¡
            volumeBars.forEach(bar => {
                bar.style.height = '0';
            });

            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                console.log('[INFO] å½•éŸ³å·²åœæ­¢');
            }
            
            // åœæ­¢éŸ³é¢‘æµ
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // æ¸…ç†éŸ³é¢‘ä¸Šä¸‹æ–‡
            if (audioContext) {
                audioContext.close();
                audioContext = null;
                analyser = null;
                microphone = null;
                dataArray = null;
            }
            
            // å¦‚æœæ²¡æœ‰è¯†åˆ«åˆ°å†…å®¹ï¼Œæ¢å¤åˆå§‹çŠ¶æ€
            if (!fullText.trim()) {
                resultContainer.innerHTML = '<div class="text-gray-400 italic text-center py-16"><i class="fa fa-file-text-o text-4xl mb-3 block opacity-30"></i><p>è¯†åˆ«çš„æ–‡å­—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p></div>';
            }
        }

        // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
        function copyToClipboard() {
            if (fullText.trim()) {
                navigator.clipboard.writeText(fullText).then(() => {
                    // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                    copyToast.classList.remove('translate-y-20', 'opacity-0');
                    copyToast.classList.add('translate-y-0', 'opacity-100');
                    
                    // 3ç§’åéšè—æç¤º
                    setTimeout(() => {
                        copyToast.classList.add('translate-y-20', 'opacity-0');
                        copyToast.classList.remove('translate-y-0', 'opacity-100');
                    }, 3000);
                }).catch(err => {
                    console.error(`[é”™è¯¯] æ— æ³•å¤åˆ¶æ–‡æœ¬: ${err}`);
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
                });
            } else {
                alert('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹');
            }
        }

        // ä¿å­˜æ–‡æœ¬
        function saveText() {
            if (fullText.trim()) {
                // åˆ›å»ºä¸€ä¸ªBlobå¯¹è±¡
                const blob = new Blob([fullText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                // åˆ›å»ºä¸€ä¸ªaæ ‡ç­¾ç”¨äºä¸‹è½½
                const a = document.createElement('a');
                a.href = url;
                const now = new Date();
                const dateString = now.toISOString().slice(0,10).replace(/-/g,'');
                a.download = `è¯¾å ‚ç¬”è®°_${dateString}.txt`;
                document.body.appendChild(a);
                a.click();
                
                // æ¸…ç†
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
                saveToast.classList.remove('translate-y-20', 'opacity-0');
                saveToast.classList.add('translate-y-0', 'opacity-100');
                
                // 3ç§’åéšè—æç¤º
                setTimeout(() => {
                    saveToast.classList.add('translate-y-20', 'opacity-0');
                    saveToast.classList.remove('translate-y-0', 'opacity-100');
                }, 3000);
            } else {
                alert('æ²¡æœ‰å¯ä¿å­˜çš„å†…å®¹');
            }
        }

        // æ¸…ç©ºæ–‡æœ¬
        function clearText() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºè¯†åˆ«ç»“æœå—ï¼Ÿ')) {
                fullText = '';
                updateFullText('');
                resultContainer.innerHTML = '<div class="text-gray-400 italic text-center py-16"><i class="fa fa-file-text-o text-4xl mb-3 block opacity-30"></i><p>è¯†åˆ«çš„æ–‡å­—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p></div>';
                updateLastUpdateTime();
            }
        }

        // å¤åˆ¶é‚®ç®±
        function copyEmail() {
            const email = emailAddress.textContent;
            navigator.clipboard.writeText(email).then(() => {
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                emailToast.classList.remove('translate-y-20', 'opacity-0');
                emailToast.classList.add('translate-y-0', 'opacity-100');
                
                // 3ç§’åéšè—æç¤º
                setTimeout(() => {
                    emailToast.classList.add('translate-y-20', 'opacity-0');
                    emailToast.classList.remove('translate-y-0', 'opacity-100');
                }, 3000);
                
                // å…³é—­å¼¹çª—
                contactModal.classList.add('hidden');
                contactModal.classList.remove('flex');
            }).catch(err => {
                console.error(`[é”™è¯¯] æ— æ³•å¤åˆ¶é‚®ç®±: ${err}`);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é‚®ç®±åœ°å€ã€‚');
            });
        }

        // äº‹ä»¶ç›‘å¬
        startBtn.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });
        
        saveBtn.addEventListener('click', saveText);
        copyBtn.addEventListener('click', copyToClipboard);
        clearBtn.addEventListener('click', clearText);
        
        // å¸®åŠ©å¼¹çª—æ§åˆ¶
        helpBtn.addEventListener('click', () => {
            helpModal.classList.remove('hidden');
            helpModal.classList.add('flex');
        });
        
        closeHelp.addEventListener('click', () => {
            helpModal.classList.add('hidden');
            helpModal.classList.remove('flex');
        });
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) {
                helpModal.classList.add('hidden');
                helpModal.classList.remove('flex');
            }
        });
        
        // è”ç³»æˆ‘å¼¹çª—æ§åˆ¶
        contactBtn.addEventListener('click', () => {
            contactModal.classList.remove('hidden');
            contactModal.classList.add('flex');
        });
        
        contactModal.addEventListener('click', (e) => {
            if (e.target === contactModal) {
                contactModal.classList.add('hidden');
                contactModal.classList.remove('flex');
            }
        });
        
        copyEmailBtn.addEventListener('click', copyEmail);

        // é¡µé¢åŠ è½½æ—¶å°è¯•è¿æ¥WebSocket
        window.addEventListener('load', () => {
            connectWS();
            updateLastUpdateTime();
        });

        // é¡µé¢å…³é—­æ—¶ç¡®ä¿å…³é—­è¿æ¥å’Œå½•éŸ³
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        });
    </script>
</body>
</html>
